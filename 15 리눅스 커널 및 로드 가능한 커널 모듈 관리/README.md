# 칼리 리눅스 실습 15

 - 리눅스에서 중요한 두 가지 요소는 커널,사용자 공간(커널을 제외한 공간)이다.
 - 커널은 루트나 기타 권한을 가지고 있는 계정에 의해서만 접근이 가능한 보호 구역으로 설계되었다.
 - 커널로 접근한다는 것은 운영체제로서의 거의 자유로운 접근이 가능하다는 것이다.
 - 사용자가 커널로 접근하면 운영체제의 동작, 겉모습을 변경해 망가뜨릴 수 있다.
 - 이 장에서는 커널의 작동 방식을 변경하는 방법과 커널에 새 모듈을 추가하는 법을 알아본다.
 - 만약 해커가 대상의 커널을 변경한다면, 시스템을 장악할 수도 있으니 특정 공격에 대해 커널의 작동하는 방식을 변경할 필요가 있다.

## 커널 모듈이란?
 - 커널은 운영체제의 중추 신경계로서 실행되는 모든 것을 제어한다.(하드웨어 간 운영 포함)
 - 리눅스는 커널 모듈의 추가가 가능한 모놀리식 커널이다. 모듈은 커널에 추가되고 제거가 가능하다. 또한 업데이트가 주기적으로 필요하다.
 - 이는 새 장치 드라이버, 파일 시스템 드라이버, 시스템 확장을 수반하기도 한다.
 - 어떤 시스템에서는 드라이버를 추가하기 위해 재빌드,컴파일,재부팅이 필요하지만 리눅스는 몇몇 모듈을 커널에 추가하는 것이 가능하다.
 - 이러한 모듈을 로드 가능한 커널 모듈, 즉 LKM(loadable kernel module)이라고 부른다.
 - LKM은 필요에 따라 커널 하위 수준에 접근할 수 있다. 루트킷이라고 알려진 특정 맬웨어는 LKM을 통해 커널로 잠입할 수 있다.
 - 따라서 해커가 성공적으로 리눅스 관리자를 취하고, 루트킷이 포함되어있는 비디오, 또는 기타 장치 드라이버를 설치한다면, 모든 것을 제어할 수 있다.
 - uname -a : 커널의 버전을 알려준다. 나의 경우 Linux kali 6.8.11-amd64 #1 SMP PREEMPT_DYNAMIC Kali 6.8.11-1kali2 (2024-05-30) x86_64 GNU/Linux이다. SMP(symmetric multiprocessing),x86_64 아키텍쳐이다.
 - cat /proc/version 으로도 알 수 있다.

### sysctl을 통한 커널 튜닝
 - 올바른 명령으로 커널의 메모리 할당을 변경,네트워크 기능을 활성화,커널을 강화하기 등 커널을 튜닝할 수 있다.
 - 현대 리눅스는 sysctl을 통해 이뤄지는 모든 변경점은 시스템이 재부팅할 때까지만 적용된다. 영구적으로 만들기 위해서는 /etc/sysctl.conf를 수정해야 한다. 그러나 적절한 지식 없이는 시스템을 부팅 불가능하게 만들 수도 있으니 조심하자.
 - sysctl -a | less -> 현재 주어진 옵션을 알 수 있다.
 - 해커에게 유용한 옵션들을 보고 사용방법에 대한 예로서 패킷 포워딩을 활성화해보자.
 - 중간자(MITM) 공격에서 해커는 자신을 호스트들 사이에 위치해서 중간에 정보를 탈취한다. 이로써 트래픽은 해커의 시스템을 통과한다. 따라서 해커는 정보를 조회하고 통신을 변조할 수 있다.
 - 이를 위해 패킷 포워딩을 활성화한다. sysctl -a | grep ipv4 | less를 입력하면 net.ipv4.ip_forward = 0이라고 되어있는 칸을 발견할 것이다.
 ```
net.ipv4.ip_forward = 0 -> sysctl -w net.ipv4.ip_forward = 1로 이것을 1로 변경해보자. 물론 재부팅되면 변경을 잃는다.
net.ipv4.ip_forward_update_priority = 1
net.ipv4.ip_forward_use_pmtu = 0
net.ipv4.ip_local_port_range = 32768    60999
net.ipv4.ip_local_reserved_ports = 
net.ipv4.ip_no_pmtu_disc = 0
net.ipv4.ip_nonlocal_bind = 0
net.ipv4.ip_unprivileged_port_start = 0
net.ipv4.ipfrag_high_thresh = 4194304
net.ipv4.ipfrag_low_thresh = 3145728
net.ipv4.ipfrag_max_dist = 64
net.ipv4.ipfrag_secret_interval = 0

 ```
 - 이제 영구 적용을 위해 /etc/sysctl.conf를 수정하자. 들어가서 #net.ipv4.ip_forward=1에서 주석을 해제하고 저장하면 된다.
 - 만약 운영체제 강화의 관점에서 net.ipv4.icmp_echo_ignore_all=1 줄을 추가하여 ICMP 에코 요청을 비활성화할 수 있다. 이는 해커가 우리의 시스템을 찾는 것을 더 어렵게 한다.

## 커널 모듈 관리
 - 리눅스가 커널 모듈을 관리하는 데에는 적어도 2가지 방법이 있다. 그 중 insmod suite(스위트)를 통해 빌드된 일련의 명령어 집합을 사용하는 것이 있다.insmod(insert module)은 모듈을 다루기 위해 제작되었다.
 - 2번째 방법은 modprobe 명령을 이용하는 것이다. 이는 후반에서 살펴본다.
🛠 커널 모듈 관련 명령어 (Linux 기준)
1. 모듈 목록 확인: lsmod
``` 모든 커널 모듈 및 그 크기와 어떤 다른 모듈이 그들을 사용하는지 정보를 포함해 나열된다.
Module                  Size  Used by
snd_seq_dummy          12288  0
snd_hrtimer            12288  1
snd_seq               114688  7 snd_seq_dummy
snd_seq_device         16384  1 snd_seq
rfkill                 40960  2
qrtr                   57344  4
vboxsf                 49152  0
sunrpc                880640  1
intel_rapl_msr         20480  0
intel_rapl_common      36864  1 intel_rapl_msr
intel_uncore_frequency_common    16384  0
intel_pmc_core        114688  0
intel_vsec             20480  1 intel_pmc_core
pmt_telemetry          16384  1 intel_pmc_core
pmt_class              12288  1 pmt_telemetry
snd_intel8x0           49152  1
snd_ac97_codec        196608  1 snd_intel8x0
```
2. 모듈 로드 (추가): insmod [모듈파일].ko
3. 모듈 언로드 (제거): rmmod [모듈이름]
 - 2,3은 모듈을 추가하고 삭제할 수 있지만, 모듈 의존성을 고려하지 않아 커널을 불안정하게 할 수 있다.
 - 그래서 현대 리눅스 배포판들은 modprobe 명령을 추가하였다.
4. 모듈 정보 확인: modinfo [모듈이름]
 - 커널 모듈에 대해 더 많은 정보를 얻고 싶을 때 쓴다.
 - modeinfo bluetooth
 ``` 블루투스 커널 모듈에 대한 기본 정보를 얻고 싶을 때 이렇게 쓰면 된다.
 filename:       /lib/modules/6.8.11-amd64/kernel/net/bluetooth/bluetooth.ko.xz
alias:          net-pf-31
license:        GPL
version:        2.22 -> 버전
description:    Bluetooth Core ver 2.22 -> 버전(조금 자세히)
author:         Marcel Holtmann <marcel@holtmann.org> -> 제작자
srcversion:     0D5233EE439C5DF7F86C8F9
depends:        rfkill,crc16,ecdh_generic -> rfkill,crc16,ecdh_generic 커널 모듈에 의존(이용하기 위해 이것들을 설치해야함.)한다는 것을 보여준다.
retpoline:      Y
intree:         Y
name:           bluetooth
vermagic:       6.8.11-amd64 SMP preempt mod_unload modversions 
sig_id:         PKCS#7
signer:         Build time autogenerated kernel key
sig_key:        36:FF:46:CD:26:21:E6:48:79:E5:E1:7E:17:69:00:7C:42:77:2E:2E
sig_hashalgo:   sha256
signature:      B3:4F:A2:CC:02:72:15:29:B0:A7:0A:8A:4D:A5:46:23:0A:1F:31:A9:
                C0:59:1A:70:48:C1:F5:2C:3C:89:E0:69:13:02:B4:8F:BA:C5:8A:45:
                ....
                94:5B:C0:74:35:6C:21:BF:9D:FB:F8:64:D2:02:AF:43:8A:4A:A2:17:
                EB:88:32:23:30:24:E4:57:7C:A3:6A:FD
parm:           disable_esco:Disable eSCO connection creation (bool)
parm:           disable_ertm:Disable enhanced retransmission mode (bool)
parm:           enable_ecred:Enable enhanced credit flow control mode (bool)
 ```

## modprobe를 통한 모듈의 추가 및 제거
 - modprobe -a(add추가 옵션) [모듈명] : 모듈 추가
 - modprobe -r(remove삭제 옵션) [삭제할 모듈명] : 모듈 삭제
 - 새 비디오 카드를 설치하고 그를 위한 드라이버를 설치한다고 가정해보자. 장치 드라이버는 기능을 수행하기 위한 손쉬운 접근을 위해 보통 커널에 직접 설치한다. 이는 악의적인 해커나 루트킷이나 기타 도구를 장치에 설치할 수 있는 비옥한 토양이 되기도 한다.
 예시로 modprobe -a HackersAriseNewVideo를 입력하고 로딩되었는지 확인하려면 커널에 메시지 버퍼를 출력하는 dmesg를 입력해보자.
 - dmesg | grep video -> 해당 출력에 'video'를 포함한 커널 메시지가 존재한다면 출력될 것이다. 아무것도 나오지 않는다면 이 키워드에 해당하는 메시지가 없다는 것이다. 그리고 이제 modprobe -r HackersAriseNewVideo를 하면 커널 모듈이 제거될 것이다.

### 요약
 - 커널은 운영체제의 핵심인 동시에 보안이 뚫리면 운영체제가 망가진다.
 - LKM은 시스템 관리자가 모듈 추가를 원할 때 전체 커널을 빌드하지 않고 커널에 직접 모듈을 추가할 수 있게 해준다.
 - 그러므로 해커가 악의적인 LKM을 추가하도록 한다면, 해커는 시스템 전체 제어권을 취할 수 있다. 대부분의 경우에 시스템 관리자는 이를 알지도 못한다.
 



